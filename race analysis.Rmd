---
title: "Race Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

library(tidyverse)


````


```{r}




setwd("~/Projects/F1/Data")



circuits <- read_csv("circuits.csv")

constures <- read_csv("constructor_results.csv")

construcst <- read_csv("constructor_standings.csv")

constructors <- read_csv("constructors.csv")

dristan <- read_csv("driver_standings.csv")


drivers <- read_csv("drivers.csv")


laptimes <- read_csv("lap_times.csv")


pits <- read_csv("pit_stops.csv")

qual = read_csv("qualifying.csv")

races <- read_csv("races.csv")

results <- read_csv("results.csv")

seasons <- read_csv("seasons.csv")

status <- read_csv("status.csv")



tyreuse <- read_csv("F1 Tyre Usage.csv")



```



```{r}



lando <- laptimes %>% left_join(races, by = "raceId") %>%
                                left_join(drivers, by = "driverId") %>%
                        left_join(pits, by = c("raceId", "lap", "driverId")) %>%
                            filter(name == "Bahrain Grand Prix") %>%
                              filter(year > 2020) %>%
                                filter(code %in% c("NOR")) %>%
                                  mutate(seconds = milliseconds.x / 1000) %>%
                                      group_by(year) %>%
                                      fill(stop) %>%
                                      mutate(stint = if_else(is.na(stop),1, 1 + stop)) %>%
                                      mutate(lugdur = lag(duration)) %>%
                                        mutate(stopfl = if_else(!is.na(duration),1 ,
                                                          if_else(!is.na(lugdur), 1, 2))) %>%
                                          filter(stopfl == 2) %>%
                                              filter(seconds < 100)


ggplot(lando, aes(x = lap, y = seconds, col = as.factor(year))) + 
                                        geom_point() +  geom_smooth(method = "lm", se = F) +
                                          facet_wrap(~stint, scales = "free_x")



```






```{r}




lando <- laptimes %>% left_join(races, by = "raceId") %>%
                                left_join(drivers, by = "driverId") %>%
                        left_join(pits, by = c("raceId", "lap", "driverId")) %>%
                            filter(name == "Bahrain Grand Prix") %>%
                              filter(year > 2020) %>%
                                filter(code %in% c("HAM", "VER")) %>%
                                  mutate(seconds = milliseconds.x / 1000) %>%
                                      group_by(code) %>%
                                      fill(stop) %>%
                                      mutate(stint = if_else(is.na(stop),1, 1 + stop)) %>%
                                      mutate(lugdur = lag(duration)) %>%
                                        mutate(stopfl = if_else(!is.na(duration),1 ,
                                                          if_else(!is.na(lugdur), 1, 2))) %>%
                                          filter(stopfl == 2) %>%
                                              filter(seconds < 100) %>%
                                                filter(stint < 4)


ggplot(lando, aes(x = lap, y = seconds, col = as.factor(code))) + 
                                        geom_point() +  geom_smooth(method = "lm", se = F) +
                                          facet_wrap(~stint, scales = "free_x")









````

```{r}


pits31 <- pits %>% filter(raceId == 1031)
 

```


```{r}




ham <- laptimes %>% left_join(races, by = "raceId") %>%
                                left_join(drivers, by = "driverId") %>%
                        left_join(pits, by = c("raceId", "lap", "driverId")) %>%
                            filter(raceId == 1031) %>%
                                filter(code %in% c("ALB")) %>%
                                  mutate(seconds = milliseconds.x / 1000) %>%
                                      group_by(code) %>%
                                      fill(stop) %>%
                                      mutate(stint = if_else(is.na(stop),1, 1 + stop)) %>%
                                      mutate(lugdur = lag(duration)) %>%
                                        mutate(stopfl = if_else(!is.na(duration),1 ,
                                                          if_else(!is.na(lugdur), 1, 2))) %>%
                                         
                                                  ungroup() %>%
                                                    group_by(stint) %>%
                                                        mutate(stintlp = 1:n()) 




ggplot(ham, aes(x = lap, y = seconds, col = as.factor(stint))) + geom_point()



`````

```{R}


HAM2 <- ham %>% filter(stintlp < 17) %>%
                      group_by(stint) %>%
                        summarise(meanl = mean(seconds))



```


```{r}


ham3 <- ham %>% ungroup() %>%
          mutate(fueladj = seconds - (lap *0.07)) 


ggplot(ham3, aes(x = lap, y = fueladj)) + geom_point()
```

```{r}




BOT <- laptimes %>% left_join(races, by = "raceId") %>%
                                left_join(drivers, by = "driverId") %>%
                        left_join(pits, by = c("raceId", "lap", "driverId")) %>%
                            filter(name == "Bahrain Grand Prix") %>%
                              filter(year > 2020) %>%
                                filter(code %in% c("BOT")) %>%
                                  mutate(seconds = milliseconds.x / 1000) %>%
                                      group_by(code) %>%
                                      fill(stop) %>%
                                      mutate(stint = if_else(is.na(stop),1, 1 + stop)) %>%
                                      mutate(lugdur = lag(duration)) %>%
                                        mutate(stopfl = if_else(!is.na(duration),1 ,
                                                          if_else(!is.na(lugdur), 1, 2))) %>%
                                         
                                                  ungroup() %>%
                                                    group_by(stint) %>%
                                                        mutate(stintlp = 1:n()) %>%
                                                        mutate(fueladj = 97.0661-(lap*0.0873))








ggplot(BOT, aes(x = lap, y = fueladj)) + geom_point()




````

```{r}


qualbest <- qual %>% pivot_longer(cols = 7:9, names_to = "qaul", values_to = "times") %>%
                                    filter(qaul == "q3") %>%
                                      separate(times, into = c("m", "s","ms"), sep = ":")


qualbest$m <- as.numeric(as.character(qualbest$m))

qualbest$s <- as.numeric(as.character(qualbest$s))



qualbest2 <- qualbest %>% mutate(qualt = m * 60 + s) %>%
                      left_join(races, by = "raceId") %>%
                            left_join(circuits, by = "circuitId") %>%
                                group_by(circuitId) %>%
                                  slice_min(qualt)



                              




```
```{r}



lapfil_test <- laptimes %>% left_join(races, by = "raceId") %>%
                                left_join(drivers, by = "driverId") %>%
                        left_join(pits, by = c("raceId", "lap", "driverId")) %>%
                              filter(year > 2010) %>%
                                  mutate(seconds = milliseconds.x / 1000) %>%
                                      group_by(code, raceId) %>%
                                      fill(stop) %>%
                                      mutate(stint = if_else(is.na(stop),1, 1 + stop)) %>%
                                      mutate(lugdur = lag(duration)) %>%
                                        mutate(stopfl = if_else(!is.na(duration),1 ,
                                                          if_else(!is.na(lugdur), 1, 2))) %>%
                                            left_join(qualbest2, by = "circuitId") %>%
                                              mutate(delta = seconds/qualt-1) %>%
                                                filter(seconds < 200)



ggplot(lapfil_test, aes(x = delta)) + geom_density()









```

```{r}




tyre_use2 <- tyreuse %>% pivot_longer(cols = 4:14, names_to = "na", values_to = "tyre") %>%
                                  separate(na, into = c("nar", "stint"), "_")











```



```{r}




all_stints <- laptimes %>% left_join(races, by = "raceId") %>%
                                left_join(drivers, by = "driverId") %>%
                        left_join(pits, by = c("raceId", "lap", "driverId")) %>%
                              filter(year > 2019) %>%
                                  mutate(seconds = milliseconds.x / 1000) %>%
                                      group_by(code, raceId) %>%
                                      fill(stop) %>%
                                      mutate(stint = if_else(is.na(stop),1, 1 + stop)) %>%
                                      mutate(lugdur = lag(duration)) %>%
                                        mutate(stopfl = if_else(!is.na(duration),1 ,
                                                          if_else(!is.na(lugdur), 1, 2))) %>%
                                            left_join(qualbest2, by = "circuitId") %>% 
                                              
                                              mutate(delta = seconds/qualt-1) %>%
                                                filter(delta < 0.5) %>%
                                                  ungroup() %>%
                                                    group_by(stint) %>%
                                                        mutate(stintlp = 1:n()) %>%
                                                          group_by(code, year.x, round.x, stint) %>%
                                                            summarise(medl = median(seconds)) 

colnames(all_stints)[1] <- "Year"
colnames(all_stints)[2] <- "Season"



```
